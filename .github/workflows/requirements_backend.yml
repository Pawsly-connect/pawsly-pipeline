name: requirements-backend

on:
  workflow_call:
    inputs:
      project-name:
        description: 'Project name wich is gonna be the project identifier in Sonarcloud'
        required: false
        default: ${{ github.repository }}
        type: string
      organization:
        description: 'Organization name in github and sonar'
        required: false
        default: "Pawsly-connect"
        type: string

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Analyze with SonarCloud
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.branch.target=${{ github.event.pull_request.head.ref }}
          -Dsonar.branch.name=${{ github.event.pull_request.head.ref }}
          -Dsonar.projectKey=${{ inputs.organization }}_${{ inputs.project-name }}
          -Dsonar.organization=${{ inputs.organization }}
    - name: SonarCloud Verify results
      shell: bash
      run: |
        state_sonar=$(curl --location --request GET 'https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ inputs.organization }}_${{ inputs.project-name }}&branch=${{ github.event.pull_request.head.ref }}' | jq '.projectStatus.status')
        if [ "$state_sonar" != "\"OK\"" ]; then echo "Quality Gate with state: $state_sonar"; exit 1; else echo "Quality Gate OK"; exit 0; fi
