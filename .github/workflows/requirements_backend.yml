name: requirements-backend

on:
  workflow_call:
    inputs:
      project-key:
        description: 'Project key wich is gonna be the project identifier in Sonarcloud'
        required: true
        type: string
      command-test:
        description: 'Command to execute test coverage'
        required: false
        default: 'npm run test:coverage'
        type: string
      organization:
        description: 'Organization name in github and sonar'
        required: false
        default: "pawsly-connect"
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
      - name: Install and build tests
        shell: bash
        run: npm ci && ${{ inputs.command_test }}
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: lcov-report
          retention-days: 1
          path: coverage/lcov.info
  sonarcloud:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: Download coverage report
      uses: actions/download-artifact@v3
      with:
        name: lcov-report
        path: coverage
    - name: Analyze with SonarCloud
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.branch.target=${{ github.event.pull_request.base.ref }}
          -Dsonar.branch.name=${{ github.event.pull_request.base.ref }}
          -Dsonar.projectKey=${{ inputs.project-key }}
          -Dsonar.organization=${{ inputs.organization }}
    - name: SonarCloud Verify results
      shell: bash
      run: |
        state_sonar=$(curl --location --request GET 'https://sonarcloud.io/api/qualitygates/project_status?projectKey=${{ inputs.project-key }}&branch=${{ github.event.pull_request.base.ref }}' | jq '.projectStatus.status')
        if [ "$state_sonar" != "\"OK\"" ]; then echo "Quality Gate with state: $state_sonar"; exit 1; else echo "Quality Gate OK"; exit 0; fi
